package client

import (
	"encoding/json"
	"io/ioutil"
	"log"
	"net/http"
	"os"
)

type Config struct {
	BaseUrl     string `json:"baseurl"`
	AccountPath string `json:"account"`
	CvePath     string `json:"cve"`
	CwePath     string `json:"cwe"`
	VendorsPath string `json:"vendors"`
	ReportsPath string `json:"reports"`
	AlertsPath  string `json:"alerts"`
}

type Credentials struct {
	Username string `json:"user"`
	Password string `json:"pass"`
}

type CveGeneric struct {
	Id          string `json:"id"`
	Summary     string `json:"summary"`
	TimeCreated string `json:"created_at"`
	TimeUpdated string `json:"updated_at"`
}

func readConfig() Config {
	// Reading the config file 'config.json'
	configFile, err := os.Open("config.json")
	if err != nil {
		log.Fatal("Error reading config file: ", err)

	}
	defer configFile.Close()

	byteValue, _ := ioutil.ReadAll(configFile)

	var config Config

	json.Unmarshal(byteValue, &config)

	return config

}

func readCredentials() Credentials {
	// Reading the credentials file 'credentials.json'
	credFile, err := os.Open("credentials.json")
	if err != nil {
		log.Fatal("Error reading config file: ", err)

	}
	defer credFile.Close()

	byteValue, _ := ioutil.ReadAll(credFile)

	var creds Credentials

	json.Unmarshal(byteValue, &creds)

	return creds
}

func GetCveByVendor(vendor string, page string) []CveGeneric {

	creds := readCredentials()
	config := readConfig()

	cveReqUrl := config.BaseUrl + config.CvePath

	req, err := http.NewRequest(http.MethodGet, cveReqUrl, nil)
	if err != nil {
		log.Fatal("error building request: ", err)

	}

	req.SetBasicAuth(creds.Username, creds.Password)
	req.Header.Add("page", page)
	req.Header.Add("vendor", vendor)
	req.Header.Add("Accept", "application/json")

	res, err := http.DefaultClient.Do(req)
	if err != nil {
		log.Fatal("error performing request: ", err)
	}

	response, err := ioutil.ReadAll(res.Body)
	if err != nil {
		log.Fatal("error reading: ", err)
	}
	var respObj []CveGeneric

	if err := json.Unmarshal([]byte(response), &respObj); err != nil {
		log.Fatal("couldnt unmarshal to the response struct: ", err)
	}
	return respObj

}

func GetCveDetails(cve_id string) string {

	creds := readCredentials()
	config := readConfig()

	cveReqUrl := config.BaseUrl + config.CvePath + cve_id

	req, err := http.NewRequest(http.MethodGet, cveReqUrl, nil)
	if err != nil {
		log.Fatal("error building request: ", err)
	}

	req.SetBasicAuth(creds.Username, creds.Password)
	req.Header.Add("Accept", "application/json")

	res, err := http.DefaultClient.Do(req)
	if err != nil {
		log.Fatal("Error performing request: ", err)
	}

	response, err := ioutil.ReadAll(res.Body)
	if err != nil {
		log.Fatal("error reading: ", err)
	}
	returnString := string(response[:])
	return returnString

}
