package client

import (
	"encoding/json"
	"io/ioutil"
	"log"
	"net/http"
	"os"
)

type Config struct {
	BaseUrl     string `json:"baseurl"`
	AccountPath string `json:"account"`
	CvePath     string `json:"cve"`
	CwePath     string `json:"cwe"`
	VendorsPath string `json:"vendors"`
	ReportsPath string `json:"reports"`
	AlertsPath  string `json:"alerts"`
}

// idk if theres a better way to use getter methods **shrug**
func (c Config) Base() string {

	return c.BaseUrl
}
func (c Config) Account() string {

	return c.AccountPath
}
func (c Config) Cve() string {

	return c.CvePath
}
func (c Config) Cwe() string {

	return c.CwePath
}
func (c Config) Vendors() string {

	return c.VendorsPath
}
func (c Config) Reports() string {

	return c.VendorsPath
}
func (c Config) Alerts() string {

	return c.AlertsPath
}

type Credentials struct {
	Username string `json:"user"`
	Password string `json:"password"`
}

// getter methods because i dont know a better way lol
func (creds Credentials) User() string {

	return creds.Username
}
func (creds Credentials) Pass() string {

	return creds.Password
}

func readConfig() Config {
	// Reading the config file 'config.json'
	configFile, err := os.Open("config.json")
	if err != nil {
		log.Fatal("Error reading config file: ", err)

	}
	defer configFile.Close()

	byteValue, _ := ioutil.ReadAll(configFile)

	var config Config

	json.Unmarshal(byteValue, &config)

	return config

}

func readCredentials() Credentials {
	// Reading the credentials file 'credentials.json'
	credFile, err := os.Open("credentials.json")
	if err != nil {
		log.Fatal("Error reading config file: ", err)

	}
	defer credFile.Close()

	byteValue, _ := ioutil.ReadAll(credFile)

	var creds Credentials

	json.Unmarshal(byteValue, &creds)

	return creds
}

func GetCveByVendor(vendor string, page string) *http.Response {

	creds := readCredentials()
	config := readConfig()

	cveReqUrl := config.Base() + config.Cve()

	req, err := http.NewRequest(http.MethodGet, cveReqUrl, nil)
	if err != nil {
		log.Fatal("error building request: ", err)

	}

	req.SetBasicAuth(creds.User(), creds.Pass())
	req.Header.Add("page", page)
	req.Header.Add("vendor", vendor)
	req.Header.Add("Accept", "application/json")

	res, err := http.DefaultClient.Do(req)
	if err != nil {
		log.Fatal("error performing request: ", err)
	}
	return res
}
